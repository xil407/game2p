<!DOCTYPE html>
<html>
<head>
    <title>Pixel Fight - Android & PC Friendly</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #111; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; color: white; }
        canvas { display: block; background: #222; }
        
        /* Menu Utama */
        #startOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; padding: 10px;
        }

        .mode-select { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { padding: 8px 15px; background: #333; border: 2px solid #555; color: white; cursor: pointer; border-radius: 5px; font-size: 12px; }
        .mode-btn.active { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; }

        .select-container { 
            display: flex; justify-content: center; gap: 5px; width: 100%; 
            max-width: 900px; max-height: 45vh; overflow-y: auto;
            padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;
        }
        
        .select-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .char-card { border: 1px solid #444; padding: 3px; text-align: center; cursor: pointer; border-radius: 5px; background: #222; width: 55px; font-size: 8px; }
        .char-card.selected-p1 { border-color: #00ffff; box-shadow: 0 0 8px #00ffff; }
        .char-card.selected-p2 { border-color: #ff4444; box-shadow: 0 0 8px #ff4444; }
        .char-card img { width: 40px; height: 40px; display: block; margin: 0 auto 2px; border-radius: 3px; object-fit: cover; }
        
        #startButton { margin-top: 15px; padding: 12px 40px; font-size: 18px; font-weight: bold; background: #00ffff; border: none; border-radius: 8px; cursor: pointer; color: black; }

        /* UI Darah & Mana */
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; pointer-events: none; z-index: 10; }
        .hp-bar { width: 120px; height: 14px; background: #444; border: 2px solid #fff; border-radius: 4px; position: relative; }
        .hp-fill { height: 100%; background: #ff4444; width: 100%; }
        .mana-fill { position: absolute; bottom: -6px; left: 0; height: 4px; background: #4444ff; width: 100%; }

        /* Mobile Controls */
        #mobileControls {
            position: fixed; bottom: 15px; width: 100%; display: none;
            justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 50;
        }
        .control-group { display: flex; gap: 8px; align-items: flex-end; }
        .touch-btn {
            width: 50px; height: 50px; background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.4); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 10px; user-select: none; color: white;
        }
        
        /* Hanya muncul di HP */
        @media (pointer: coarse) { #mobileControls { display: flex; } }
    </style>
</head>
<body>

    <audio id="bgMusic" loop><source src="naruto.mp3" type="audio/mpeg"></audio>

    <div id="startOverlay">
        <h2 style="color: #00ffff; margin: 5px;">PIXEL FIGHT</h2>
        <div class="mode-select">
            <button id="modeAI" class="mode-btn active" onclick="setMode('AI')">VS AI</button>
            <button id="modePVP" class="mode-btn" onclick="setMode('PVP')">VS PLAYER</button>
        </div>
        <div class="select-container">
            <div id="p1-box" class="select-box"></div>
            <div id="p2-box" class="select-box"></div>
        </div>
        <button id="startButton">MULAI</button>
    </div>

    <div id="ui">
        <div><div class="hp-bar"><div id="hp-p1" class="hp-fill"></div><div id="mana-p1" class="mana-fill"></div></div></div>
        <div class="touch-btn" style="width: 50px; height: 30px; pointer-events: auto; border-radius: 5px;" onclick="location.reload()">RESET</div>
        <div><div class="hp-bar"><div id="hp-p2" class="hp-fill"></div><div id="mana-p2" class="mana-fill"></div></div></div>
    </div>

    <div id="mobileControls">
        <div class="control-group">
            <div class="touch-btn" id="t-left">←</div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <div class="touch-btn" id="t-up">↑</div>
                <div class="touch-btn" id="t-down">CHRG</div>
            </div>
            <div class="touch-btn" id="t-right">→</div>
        </div>
        <div class="control-group">
            <div class="touch-btn" id="t-hit" style="background: rgba(255, 68, 68, 0.4);">HIT</div>
            <div class="touch-btn" id="t-ult" style="background: rgba(255, 255, 255, 0.4);">ULT</div>
            <div class="touch-btn" id="t-magic" style="background: rgba(68, 68, 255, 0.4);">MAG</div>
        </div>
    </div>

    <canvas id="fightCanvas"></canvas>

    <script>
        const canvas = document.getElementById("fightCanvas");
        const ctx = canvas.getContext("2d");
        const music = document.getElementById("bgMusic");
        const bgImg = new Image(); bgImg.src = "background.jpeg";

        // SOUND SYSTEM
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'jump') { osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(600, now + 0.1); gain.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now + 0.1); }
            else if (type === 'hit') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(); osc.stop(now + 0.2); }
            else if (type === 'blink') { osc.type = 'square'; osc.frequency.setValueAtTime(900, now); osc.frequency.exponentialRampToValueAtTime(100, now + 0.1); gain.gain.setValueAtTime(0.05, now); osc.start(); osc.stop(now + 0.1); }
        }

        const heroes = [
            { name: "Shadow", img: "player.png", speed: 7, color: "#00ffff", dmg: 14, manaCost: 20 },
            { name: "Knight", img: "enemy.png", speed: 4, color: "#ffaa00", dmg: 22, manaCost: 35 },
            { name: "Kla", img: "ka.png", speed: 5, color: "#ff0000", dmg: 21, manaCost: 25 },
            { name: "Ran", img: "za.png", speed: 5, color: "#777", dmg: 20, manaCost: 29 },
            { name: "Rin", img: "zi.png", speed: 6, color: "white", dmg: 22, manaCost: 31, flip: true },
            { name: "Shizu", img: "zu.png", speed: 7, color: "pink", dmg: 21, manaCost: 27 },
            { name: "Agus", img: "agus.png", speed: 6, color: "yellow", dmg: 23, manaCost: 19, flip: true },
            { name: "Tarno", img: "tarno.png", speed: 7, color: "#0fe", dmg: 25, manaCost: 40 },
            { name: "Sai", img: "sai.png", speed: 7, color: "black", dmg: 24, manaCost: 25 },
            { name: "Sukuna", img: "sukuna.png", speed: 9, color: "white", dmg: 22, manaCost: 22 },
            { name: "Saske", img: "saske.gif", speed: 7, color: "#fcff00", dmg: 22, manaCost: 24 },
            { name: "Venom", img: "venom.gif", speed: 6, color: "white", dmg: 21, manaCost: 23 },
            { name: "Kibo", img: "kibo.png", speed: 6, color: "green", dmg: 20, manaCost: 24, flip: true }
        ];

        let currentMode = 'AI';
        let p1Idx = 0, p2Idx = 1;
        let gameActive = false, isGameOver = false, shakeTime = 0;
        let projectiles = [], slashes = [], auras = [], keys = {};
        const gravity = 0.8;

        const p1 = { x: 100, y: 0, w: 0, h: 0, hp: 100, mana: 100, vy: 0, jumping: false, charging: false, dir: 1, attacking: false, invul: false, alpha: 1, img: new Image() };
        const p2 = { x: 0, y: 0, w: 0, h: 0, hp: 100, mana: 100, vy: 0, jumping: false, charging: false, dir: -1, attacking: false, invul: false, alpha: 1, img: new Image() };

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeAI').classList.toggle('active', mode === 'AI');
            document.getElementById('modePVP').classList.toggle('active', mode === 'PVP');
        }

        function initSelection() {
            const p1Box = document.getElementById("p1-box");
            const p2Box = document.getElementById("p2-box");
            heroes.forEach((h, i) => {
                p1Box.innerHTML += `<div class="char-card ${i===0?'selected-p1':''}" id="p1-card-${i}" onclick="select(1,${i})"><img src="${h.img}"><span>${h.name}</span></div>`;
                p2Box.innerHTML += `<div class="char-card ${i===1?'selected-p2':''}" id="p2-card-${i}" onclick="select(2,${i})"><img src="${h.img}"><span>${h.name}</span></div>`;
            });
        }

        function select(pNum, idx) {
            document.querySelectorAll(pNum===1?'#p1-box .char-card':'#p2-box .char-card').forEach(c => c.classList.remove(pNum===1?'selected-p1':'selected-p2'));
            document.getElementById(pNum===1?`p1-card-${idx}`:`p2-card-${idx}`).classList.add(pNum===1?'selected-p1':'selected-p2');
            pNum===1 ? p1Idx = idx : p2Idx = idx;
        }

        // INPUT HANDLERS
        window.addEventListener("keydown", e => keys[e.code] = true);
        window.addEventListener("keyup", e => keys[e.code] = false);

        const bindTouch = (id, key) => {
            const el = document.getElementById(id);
            el.ontouchstart = (e) => { e.preventDefault(); keys[key] = true; };
            el.ontouchend = (e) => { e.preventDefault(); keys[key] = false; };
        };
        bindTouch('t-left', 'KeyA'); bindTouch('t-right', 'KeyD'); bindTouch('t-up', 'KeyW'); bindTouch('t-down', 'KeyS');
        bindTouch('t-hit', 'Space'); bindTouch('t-magic', 'KeyF'); bindTouch('t-ult', 'KeyR');

        function resize() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let size = canvas.height * 0.3;
            p1.w = p2.w = size; p1.h = p2.h = size;
            p1.ground = p2.ground = canvas.height - size - (window.innerWidth < 600 ? 80 : 60);
            if(!gameActive) { p1.y = p1.ground; p2.y = p2.ground; p2.x = canvas.width - size - 50; }
        }

        function startAttack(at, ta, col) {
            if(at.attacking || at.charging || at.alpha < 1) return;
            at.attacking = true;
            slashes.push({ x: ta.x + ta.w/2, y: ta.y + ta.h/2, life: 12, dir: (Math.random()>0.5?1:-1), color: col });
            if(Math.abs((at.x+at.w/2) - (ta.x+ta.w/2)) < at.w * 1.1) {
                ta.hp -= (ta.charging ? 2 : 7); playSound('hit'); shakeTime = 5;
            }
            setTimeout(() => at.attacking = false, 200);
        }

        function performUltimate(at, ta, col) {
            if(at.mana < 100 || at.invul) return;
            at.mana = 0; at.invul = true;
            let hits = 0;
            let interval = setInterval(() => {
                at.alpha = 0; playSound('blink');
                at.x = ta.x + (Math.random() > 0.5 ? 120 : -120);
                at.y = ta.y + (Math.random()-0.5)*100;
                slashes.push({ x: ta.x + ta.w/2, y: ta.y + ta.h/2, life: 20, color: col, scale: 2.5 });
                ta.hp -= 4; hits++;
                if(hits > 10) { clearInterval(interval); at.alpha = 1; at.invul = false; at.y = at.ground; }
            }, 100);
        }

        document.getElementById("startButton").onclick = () => {
            p1.img.src = heroes[p1Idx].img; p2.img.src = heroes[p2Idx].img;
            document.getElementById("startOverlay").style.display = "none";
            gameActive = true; music.play(); resize(); update();
        };

        function update() {
            if(!gameActive || isGameOver) return;
            ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
            if(shakeTime > 0) { ctx.translate((Math.random()-0.5)*10, (Math.random()-0.5)*10); shakeTime--; }

            // P1 CONTROLS
            p1.charging = keys["KeyS"] && !p1.jumping;
            if(p1.charging) { p1.mana = Math.min(100, p1.mana + 0.8); auras.push({x: p1.x+p1.w/2, y: p1.y+p1.h, vy:-10, life:1, color: heroes[p1Idx].color}); }
            else if(!p1.invul) {
                if(keys["KeyA"] && p1.x > 0) p1.x -= heroes[p1Idx].speed;
                if(keys["KeyD"] && p1.x < canvas.width - p1.w) p1.x += heroes[p1Idx].speed;
                if(keys["KeyW"] && !p1.jumping) { p1.vy = -18; p1.jumping = true; playSound('jump'); }
                if(keys["Space"]) startAttack(p1, p2, heroes[p1Idx].color);
                if(keys["KeyR"]) performUltimate(p1, p2, heroes[p1Idx].color);
                if(keys["KeyF"] && p1.mana >= 25) { p1.mana -= 25; projectiles.push({x: p1.x+p1.w/2, y: p1.y+p1.h/2, vx: p1.dir*15, color: heroes[p1Idx].color, owner: p1}); keys["KeyF"] = false; }
            }

            // P2 CONTROLS (PVP vs AI)
            if(currentMode === 'PVP') {
                p2.charging = keys["ArrowDown"] && !p2.jumping;
                if(p2.charging) { p2.mana = Math.min(100, p2.mana + 0.8); auras.push({x: p2.x+p2.w/2, y: p2.y+p2.h, vy:-10, life:1, color: heroes[p2Idx].color}); }
                else if(!p2.invul) {
                    if(keys["ArrowLeft"] && p2.x > 0) p2.x -= heroes[p2Idx].speed;
                    if(keys["ArrowRight"] && p2.x < canvas.width - p2.w) p2.x += heroes[p2Idx].speed;
                    if(keys["ArrowUp"] && !p2.jumping) { p2.vy = -18; p2.jumping = true; playSound('jump'); }
                    if(keys["KeyM"]) startAttack(p2, p1, heroes[p2Idx].color);
                    if(keys["KeyL"]) performUltimate(p2, p1, heroes[p2Idx].color);
                    if(keys["KeyK"] && p2.mana >= 25) { p2.mana -= 25; projectiles.push({x: p2.x+p2.w/2, y: p2.y+p2.h/2, vx: p2.dir*15, color: heroes[p2Idx].color, owner: p2}); keys["KeyK"] = false; }
                }
            } else {
                let dist = p1.x - p2.x;
                if(!p2.invul) {
                    if(p2.mana < 30 && Math.abs(dist) > 300) { p2.charging = true; p2.mana += 0.7; auras.push({x: p2.x+p2.w/2, y: p2.y+p2.h, vy: -10, life: 1, color: heroes[p2Idx].color}); }
                    else { p2.charging = false;
                        if(Math.abs(dist) < 130) { if(Math.random() < 0.1) startAttack(p2, p1, heroes[p2Idx].color); }
                        else { p2.x += (dist > 0 ? 1 : -1) * (heroes[p2Idx].speed + 1); }
                        if(p2.mana >= 100) performUltimate(p2, p1, heroes[p2Idx].color);
                    }
                }
            }

            // Physics
            [p1, p2].forEach(p => {
                p.y += p.vy; if(p.y < p.ground) p.vy += gravity; else { p.y = p.ground; p.vy = 0; p.jumping = false; }
                p.dir = (p === p1) ? (p1.x < p2.x ? 1 : -1) : (p2.x < p1.x ? 1 : -1);
                if(!p.charging && p.mana < 100) p.mana += 0.05;
            });

            // Efek-Efek
            auras.forEach((a, i) => { ctx.fillStyle = a.color; ctx.globalAlpha = a.life; ctx.fillRect(a.x+(Math.random()-0.5)*60, a.y, 10, 10); a.y += a.vy; a.life -= 0.05; if(a.life <= 0) auras.splice(i,1); });
            slashes.forEach((s, i) => { ctx.strokeStyle = s.color; ctx.lineWidth = 8; ctx.beginPath(); let sz = s.scale || 1; ctx.arc(s.x, s.y, 45 * sz, -0.5*Math.PI, 0.5*Math.PI, s.dir === -1); ctx.stroke(); s.life -= 2; if(s.life <= 0) slashes.splice(i,1); });
            projectiles.forEach((p,i) => { p.x += p.vx; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 12, 0, Math.PI*2); ctx.fill(); let target = (p.owner === p1) ? p2 : p1; if(Math.abs(p.x - (target.x+target.w/2)) < 60) { target.hp -= 12; projectiles.splice(i,1); } });

            ctx.globalAlpha = 1; draw(p1, p1Idx); draw(p2, p2Idx);
            document.getElementById("hp-p1").style.width = p1.hp + "%"; document.getElementById("hp-p2").style.width = p2.hp + "%";
            document.getElementById("mana-p1").style.width = p1.mana + "%"; document.getElementById("mana-p2").style.width = p2.mana + "%";

            if(p1.hp <= 0 || p2.hp <= 0) { isGameOver = true; alert("PERMAINAN BERAKHIR!"); location.reload(); }
            requestAnimationFrame(update);
        }

        function draw(c, idx) { ctx.save(); ctx.globalAlpha = c.alpha; ctx.translate(c.x + c.w/2, c.y + c.h/2); let s = c.dir; if(heroes[idx].flip) s *= -1; ctx.scale(s, 1); ctx.drawImage(c.img, -c.w/2, -c.h/2, c.w, c.h); ctx.restore(); }
        initSelection();
        window.addEventListener("resize", resize);
        resize();
    </script>
</body>
</html>